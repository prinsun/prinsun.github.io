<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.png">
  <link rel="mask-icon" href="/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.makeex.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="这个世界不乏浪漫之人，但在我们程序设计的圈子里，能将代码写得像诗般的人，还是凤毛麟角的。本篇文章要介绍的 Promise&amp;Future 便是我觉得非常浪漫的一种抽象思维，无论是它的命名、实际解决的问题，还是它最终的代码风格，都让我们向诗人更近了一步。 当然，我本就是一名诗人。">
<meta property="og:type" content="article">
<meta property="og:title" content="最浪漫的抽象 Promise &amp; Future">
<meta property="og:url" content="http://blog.makeex.com/2016/04/30/best-romantic-abstract-promise-and-future/index.html">
<meta property="og:site_name" content="MakeeX">
<meta property="og:description" content="这个世界不乏浪漫之人，但在我们程序设计的圈子里，能将代码写得像诗般的人，还是凤毛麟角的。本篇文章要介绍的 Promise&amp;Future 便是我觉得非常浪漫的一种抽象思维，无论是它的命名、实际解决的问题，还是它最终的代码风格，都让我们向诗人更近了一步。 当然，我本就是一名诗人。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2016-04-30T03:30:35.000Z">
<meta property="article:modified_time" content="2016-04-30T05:56:06.000Z">
<meta property="article:author" content="Makee">
<meta property="article:tag" content="Future">
<meta property="article:tag" content="Promise">
<meta property="article:tag" content="设计模式">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://blog.makeex.com/2016/04/30/best-romantic-abstract-promise-and-future/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>最浪漫的抽象 Promise & Future | MakeeX</title>
  


  <script data-pjax>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b46a193b288b66b7eb9dc75b4d74eae6";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">MakeeX</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/prinsun" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.makeex.com/2016/04/30/best-romantic-abstract-promise-and-future/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Makee">
      <meta itemprop="description" content="LIFE IS NOT EASY BUT HARD WORK ALWAYS PAYS.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MakeeX">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          最浪漫的抽象 Promise & Future
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-04-30 11:30:35" itemprop="dateCreated datePublished" datetime="2016-04-30T11:30:35+08:00">2016-04-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/Design/" itemprop="url" rel="index"><span itemprop="name">Design</span></a>
                </span>
            </span>

          
            <span id="/2016/04/30/best-romantic-abstract-promise-and-future/" class="post-meta-item leancloud_visitors" data-flag-title="最浪漫的抽象 Promise & Future" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">评论总数：</span>
    
    <a title="valine" href="/2016/04/30/best-romantic-abstract-promise-and-future/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2016/04/30/best-romantic-abstract-promise-and-future/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>这个世界不乏浪漫之人，但在我们程序设计的圈子里，能将代码写得像诗般的人，还是凤毛麟角的。本篇文章要介绍的 Promise&amp;Future 便是我觉得非常浪漫的一种抽象思维，无论是它的命名、实际解决的问题，还是它最终的代码风格，都让我们向诗人更近了一步。</p>
<p>当然，我本就是一名诗人。</p>
<span id="more"></span>

<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>Promise&amp;Future 在很多语言里都有提及，我也无法追溯到它的最初出处了。时至今日，Promise&amp;Future 已经推演成了各种样式，这里我们只关注它最核心的思想，而推演后的其它衍生概念，只会稍稍说明。</p>
<p>从 Promise&amp;Future 这样的命名来看，本身就是一件非常浪漫的事，<strong>承诺</strong>和<strong>未来</strong>，这两个词总会让人不禁想起那些年少不羁的往事。多少承诺都已经烟消云散，多少未来终是未能到来，Promise&amp;Future，年少轻狂中的轻描淡写，却烙印下太多的悲愤与不甘。</p>
<p>浪漫是感性的，但程序设计必须是理性的，所以，程序中的 Promise 是不能被遗忘的，Future 是必须要到达的（_所以，我还是更喜欢程序构建的世界_）。在我们程序设计中，<strong>Future 是 Promise 最终产生的值，它是确定的，不可变的</strong>。</p>
<p>就好像我们向自己心仪的女孩子许下诺言，未来会执子之手与子偕老。那么当时我们这个许诺的行为就是 Promise，而最终我们期望的“执子之手与子偕老”便是 Future。Future 一般包含两种结果：<strong>成功</strong>或<strong>失败</strong>，这是非常容易理解的，当然还是可以扩充其它状态的，比如：<strong>取消</strong>。</p>
<p>那么放置到我们的程序世界，把上面所述的感性思维理性的抽象后，便是 Promise&amp;Future。这种抽象思维，带来最实际的好处，便是将异步编程模型同步化，使得我们可以很方便的将一连串相关的异步计算组织起来。最早让我关注到 Promise&amp;Future 便是在非常知名的网络组件<a target="_blank" rel="noopener" href="https://github.com/netty/netty/blob/4.1/common/src/main/java/io/netty/util/concurrent/Promise.java">netty</a>中，其源码里大量用到了 Promise&amp;Future，Wiki 里这样的一句话算是非常精炼的总结：</p>
<blockquote>
<p> a future is a read-only placeholder view of a variable, while a promise is a writable</p>
</blockquote>
<p>到目前为止，上面所阐述的都是 Promise&amp;Future 的核心思想，并且是以面向对象软件设计的抽象思维来推导的。那么，当函数式编程火热起来后，Promise&amp;Future 为了能够更好的将一连串相关的异步计算组织起来，便被扩充成了<strong>Monad</strong>，关于什么是 Monad，可以去看看<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2015/07/monad.html">这篇文章</a>。扩充成了 Monad 后，便有了<code>and</code>、<code>then</code>等等不同的连接操作，这也使得它更加优雅，以至于让很多人认为，做不到这样的 Promise&amp;Future，便不是 Promise&amp;Future，这是不对的，难道没有锦衣玉食的乞丐就不是人了么？</p>
<h2 id="实际例子"><a href="#实际例子" class="headerlink" title="实际例子"></a>实际例子</h2><p>说了这么多，还是来一段代码，大家实际感受下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[[[<span class="keyword">self</span> login] onSuccess:^&#123;</span><br><span class="line">    <span class="comment">// do something success</span></span><br><span class="line">&#125;] onFailure:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">    <span class="comment">// do something error</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>仔细分析下上面这简单的代码，<code>[self login]</code>是一个有同步返回值的方法，但其本身行为是异步的，通过<code>block</code>我们也可以达到类似的效果，但对于异步返回值的级联处理就会很麻烦了，并且无法挂钩给多个处理方法。我们可以通过<a target="_blank" rel="noopener" href="https://github.com/mxcl/PromiseKit">PromiseKit</a>中提供的实例代码对比而知：</p>
<figure class="highlight objc"><figcaption><span>Block Style</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// load JSON</span></span><br><span class="line">[<span class="built_in">NSURLConnection</span> sendAsynchronousRequest:rq1 queue:q completionHandler:^(<span class="type">id</span>, <span class="type">id</span> data1, <span class="type">id</span> err) &#123;</span><br><span class="line">    <span class="comment">// load related JSON</span></span><br><span class="line">    [<span class="built_in">NSURLConnection</span> sendAsynchronousRequest:rq2 queue:q completionHandler:^(<span class="type">id</span>, <span class="type">id</span> data2, <span class="type">id</span> err) &#123;</span><br><span class="line">        <span class="comment">// load image</span></span><br><span class="line">        [<span class="built_in">NSURLConnection</span> sendAsynchronousRequest:rq3 queue:q completionHandler:^(<span class="type">id</span>, <span class="type">id</span> dat3a, <span class="type">id</span> err) &#123;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><figcaption><span>Promise&Future Style</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">NSURLConnection</span> promise:rq1].then(^(<span class="type">id</span> data1)&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSURLConnection</span> promise:rq2];</span><br><span class="line">&#125;).then(^(<span class="type">id</span> data2)&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSURLConnection</span> promise:rq3];</span><br><span class="line">&#125;).then(^(<span class="type">id</span> data3)&#123;</span><br><span class="line">    <span class="comment">// yay! the code looks consecutive!</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>PromiseKit 明显是按照 Monad 的思维来实现的，其官网关于嵌套有这样一段话，我觉得还是蛮有道理的：</p>
<blockquote>
<p>“Rightward-drift” is not just ugly, it can lead to bugs: rightward closures have access to all higher variables, so we may accidental use them or overwrite them, breaking encapsulation at the least and causing logic errors at the worst.</p>
</blockquote>
<p>也就说，嵌套不仅仅是丑陋，还有可能因为变量作用域的问题而引入 BUG。</p>
<h2 id="Objective-C-简洁实现"><a href="#Objective-C-简洁实现" class="headerlink" title="Objective-C 简洁实现"></a>Objective-C 简洁实现</h2><p>既然 Promise&amp;Future 这么浪漫，那么为了向诗人迈进，我们可能想要自己去实现一个。当然，这只是理由之一，而更实际的理由，是我们很多时候只想拥有一个非 Monad 版本的 Promise&amp;Future，因为它够简单。这里有一些设计要点：</p>
<ul>
<li>Future 是由 Promise 产生的，并且不可改变</li>
<li>Future 中的回调是必须要触发的，无关乎于什么时间去关联（_即便 Future 已经有实际值_）</li>
<li>Future 中的回调不能被多次触发</li>
<li>Future 中的回调最好能指定回调队列（_这个可以用上下文来实现，详见我的<a href="http://blog.makeex.com/2016/03/16/objc-context-design-pattern/">这篇文章</a>_）</li>
</ul>
<p>大体也就这几点，那么下面是贴代码时间：</p>
<figure class="highlight objc"><figcaption><span>Promise</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CCMPromise</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) CCMFuture *future;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">CCMPromise</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="variable language_">super</span> init]) &#123;</span><br><span class="line">        _future = [CCMFuture new];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)dynamicFuture &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.future;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)successWithValue:(<span class="type">id</span>)value &#123;</span><br><span class="line">    [<span class="keyword">self</span>.future success:value];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)failureWithError:(<span class="built_in">NSError</span> *)error &#123;</span><br><span class="line">    [<span class="keyword">self</span>.future failure:error];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><figcaption><span>Future</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - BlockMethodSignature</span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="built_in">NSBlockLiteral</span> &#123;</span><br><span class="line">    <span class="type">void</span> *isa; </span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line">    <span class="type">int</span> reserved;</span><br><span class="line">    <span class="type">void</span> (*invoke)(<span class="type">void</span> *, ...);</span><br><span class="line">    <span class="keyword">struct</span> block_descriptor &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> reserved;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> size;</span><br><span class="line">        <span class="type">void</span> (*copy_helper)(<span class="type">void</span> *dst, <span class="type">void</span> *src);</span><br><span class="line">        <span class="type">void</span> (*dispose_helper)(<span class="type">void</span> *src);</span><br><span class="line">        <span class="keyword">const</span> <span class="type">char</span> *signature;</span><br><span class="line">    &#125; *descriptor;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_OPTIONS</span>(<span class="built_in">NSUInteger</span>, <span class="built_in">NSBlockDescriptionFlags</span>) &#123;</span><br><span class="line">    <span class="built_in">NSBlockDescriptionFlagsHasCopyDispose</span> = (<span class="number">1</span> &lt;&lt; <span class="number">25</span>),</span><br><span class="line">    <span class="built_in">NSBlockDescriptionFlagsHasCtor</span> = (<span class="number">1</span> &lt;&lt; <span class="number">26</span>), </span><br><span class="line">    <span class="built_in">NSBlockDescriptionFlagsIsGlobal</span> = (<span class="number">1</span> &lt;&lt; <span class="number">28</span>),</span><br><span class="line">    <span class="built_in">NSBlockDescriptionFlagsHasStret</span> = (<span class="number">1</span> &lt;&lt; <span class="number">29</span>),</span><br><span class="line">    <span class="built_in">NSBlockDescriptionFlagsHasSignature</span> = (<span class="number">1</span> &lt;&lt; <span class="number">30</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSMethodSignature</span> *<span class="built_in">NSMethodSignatureForBlock</span>(<span class="type">id</span> block) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!block)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> <span class="built_in">NSBlockLiteral</span> *blockRef = (__bridge <span class="keyword">struct</span> <span class="built_in">NSBlockLiteral</span> *)block;</span><br><span class="line">    <span class="built_in">NSBlockDescriptionFlags</span> flags = (<span class="built_in">NSBlockDescriptionFlags</span>)blockRef-&gt;flags;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (flags &amp; <span class="built_in">NSBlockDescriptionFlagsHasSignature</span>) &#123;</span><br><span class="line">        <span class="type">void</span> *signatureLocation = blockRef-&gt;descriptor;</span><br><span class="line">        signatureLocation += <span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span>);</span><br><span class="line">        signatureLocation += <span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (flags &amp; <span class="built_in">NSBlockDescriptionFlagsHasCopyDispose</span>) &#123;</span><br><span class="line">            signatureLocation += <span class="keyword">sizeof</span>(<span class="type">void</span>(*)(<span class="type">void</span> *dst, <span class="type">void</span> *src));</span><br><span class="line">            signatureLocation += <span class="keyword">sizeof</span>(<span class="type">void</span> (*)(<span class="type">void</span> *src));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> <span class="type">char</span> *signature = (*(<span class="keyword">const</span> <span class="type">char</span> **)signatureLocation);</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:signature];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Context</span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CCMFutureContext</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)contextWithQueue:(CCMDispatchQueue *)queue</span><br><span class="line">                          parent:(CCMFutureContext *)parent;</span><br><span class="line"></span><br><span class="line">+ (CCMFutureContext *)currentContext;</span><br><span class="line">+ (<span class="type">void</span>)setCurrentContext:(CCMFutureContext *)context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) CCMDispatchQueue *dispatchQueue;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) CCMFutureContext *parentContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> CCMFutureBeginContext(CCMDispatchQueue *queue) &#123;</span><br><span class="line">    CCMFutureContext *context = [CCMFutureContext contextWithQueue:queue</span><br><span class="line">                                                            parent:[CCMFutureContext currentContext]];</span><br><span class="line">    [CCMFutureContext setCurrentContext:context];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> CCMFutureEndContext() &#123;</span><br><span class="line">    CCMFutureContext *context = [CCMFutureContext currentContext].parentContext;</span><br><span class="line">    [CCMFutureContext setCurrentContext:context];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">CCMFutureContext</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)contextWithQueue:(CCMDispatchQueue *)queue</span><br><span class="line">                          parent:(CCMFutureContext *)parent &#123;</span><br><span class="line">    CCMFutureContext *context = [CCMFutureContext new];</span><br><span class="line">    context-&gt;_dispatchQueue = queue;</span><br><span class="line">    context-&gt;_parentContext = parent;</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)setCurrentContext:(CCMFutureContext *)context &#123;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">nil</span>) &#123;</span><br><span class="line">        [[<span class="built_in">NSThread</span> currentThread].threadDictionary removeObjectForKey:<span class="string">@&quot;CCMCurrentFutureContext&quot;</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="built_in">NSThread</span> currentThread].threadDictionary[<span class="string">@&quot;CCMCurrentFutureContext&quot;</span>] = context;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (CCMFutureContext *)currentContext &#123;</span><br><span class="line">    CCMFutureContext *context = [<span class="built_in">NSThread</span> currentThread].threadDictionary[<span class="string">@&quot;CCMCurrentFutureContext&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">nil</span>) &#123;</span><br><span class="line">        context = [<span class="keyword">self</span> contextWithQueue:[CCMDispatchQueue main] parent:<span class="literal">nil</span>];</span><br><span class="line">        [<span class="keyword">self</span> setCurrentContext:context];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Future</span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">void</span>(^CCMFutureBlockWrapper)(<span class="type">id</span> value);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CCMFuture</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="type">id</span> futureValue;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) CCMDispatchQueue *dispatchQueue;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSMutableArray</span>&lt;CCMFutureBlockWrapper&gt; *blocks;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)tryExecuteCallbacks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">CCMFuture</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="variable language_">super</span> init]) &#123;</span><br><span class="line">        _dispatchQueue = [CCMDispatchQueue serialQueueWithName:<span class="string">@&quot;queue.util.future&quot;</span>];</span><br><span class="line">        _blocks = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ccm_future_complete_block_case(type, value) \</span></span><br><span class="line"><span class="meta">case type: \</span></span><br><span class="line"><span class="meta">completeBlock(nil, value); \</span></span><br><span class="line"><span class="meta">break; \</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)onComplete:(<span class="type">void</span>(^)())completeBlock &#123;</span><br><span class="line">    CCMDispatchQueue *q = [CCMFutureContext currentContext].dispatchQueue;</span><br><span class="line">    CCMFutureBlockWrapper c = ^(<span class="type">id</span> value) &#123;</span><br><span class="line">        [q async:^&#123;</span><br><span class="line">            <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSError</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                completeBlock(value, <span class="literal">nil</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value == [<span class="built_in">NSNull</span> null]) &#123;</span><br><span class="line">                completeBlock(<span class="literal">nil</span>, <span class="literal">nil</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value != <span class="literal">nil</span>) &#123;</span><br><span class="line">                <span class="built_in">NSMethodSignature</span> *methodSignature = <span class="built_in">NSMethodSignatureForBlock</span>(completeBlock);</span><br><span class="line">                <span class="keyword">if</span> (methodSignature  == <span class="literal">nil</span>) &#123;</span><br><span class="line">                    completeBlock(<span class="literal">nil</span>, value);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (methodSignature.numberOfArguments &lt; <span class="number">3</span>) &#123;</span><br><span class="line">                        completeBlock();</span><br><span class="line">                        <span class="keyword">return</span> ;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">const</span> <span class="type">char</span> type = [methodSignature getArgumentTypeAtIndex:<span class="number">2</span>][<span class="number">0</span>];</span><br><span class="line">                    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">                            ccm_future_complete_block_case(<span class="string">&#x27;@&#x27;</span>, value)</span><br><span class="line">                            ccm_future_complete_block_case(<span class="string">&#x27;c&#x27;</span>, [value charValue])</span><br><span class="line">                            ccm_future_complete_block_case(<span class="string">&#x27;i&#x27;</span>, [value intValue])</span><br><span class="line">                            ccm_future_complete_block_case(<span class="string">&#x27;s&#x27;</span>, [value shortValue])</span><br><span class="line">                            ccm_future_complete_block_case(<span class="string">&#x27;l&#x27;</span>, [value longValue])</span><br><span class="line">                            ccm_future_complete_block_case(<span class="string">&#x27;q&#x27;</span>, [value longValue])</span><br><span class="line">                            ccm_future_complete_block_case(<span class="string">&#x27;C&#x27;</span>, [value unsignedCharValue])</span><br><span class="line">                            ccm_future_complete_block_case(<span class="string">&#x27;I&#x27;</span>, [value unsignedIntValue])</span><br><span class="line">                            ccm_future_complete_block_case(<span class="string">&#x27;S&#x27;</span>, [value unsignedShortValue])</span><br><span class="line">                            ccm_future_complete_block_case(<span class="string">&#x27;L&#x27;</span>, [value unsignedLongValue])</span><br><span class="line">                            ccm_future_complete_block_case(<span class="string">&#x27;Q&#x27;</span>, [value unsignedLongLongValue])</span><br><span class="line">                            ccm_future_complete_block_case(<span class="string">&#x27;f&#x27;</span>, [value floatValue])</span><br><span class="line">                            ccm_future_complete_block_case(<span class="string">&#x27;d&#x27;</span>, [value doubleValue])</span><br><span class="line">                            ccm_future_complete_block_case(<span class="string">&#x27;B&#x27;</span>, [value boolValue])</span><br><span class="line">                        <span class="keyword">default</span>:</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;;</span><br><span class="line">   </span><br><span class="line">    [<span class="keyword">self</span>.dispatchQueue sync:^&#123;</span><br><span class="line">        [<span class="keyword">self</span>.blocks addObject:[c <span class="keyword">copy</span>]];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> tryExecuteCallbacks];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ccm_future_success_block_case(type, value) \</span></span><br><span class="line"><span class="meta">case type: \</span></span><br><span class="line"><span class="meta">successBlock(value); \</span></span><br><span class="line"><span class="meta">break; \</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)onSuccess:(<span class="type">void</span>(^)())successBlock &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> onComplete:^(<span class="built_in">NSError</span> *error, <span class="type">id</span> value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value) &#123;</span><br><span class="line">            <span class="built_in">NSMethodSignature</span> *methodSignature = <span class="built_in">NSMethodSignatureForBlock</span>(successBlock);</span><br><span class="line">            <span class="keyword">if</span> (methodSignature == <span class="literal">nil</span>) &#123;</span><br><span class="line">                successBlock(value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (methodSignature.numberOfArguments &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                    successBlock();</span><br><span class="line">                    <span class="keyword">return</span> ;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">const</span> <span class="type">char</span> type = [methodSignature getArgumentTypeAtIndex:<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">                        ccm_future_success_block_case(<span class="string">&#x27;@&#x27;</span>, value)</span><br><span class="line">                        ccm_future_success_block_case(<span class="string">&#x27;c&#x27;</span>, [value charValue])</span><br><span class="line">                        ccm_future_success_block_case(<span class="string">&#x27;i&#x27;</span>, [value intValue])</span><br><span class="line">                        ccm_future_success_block_case(<span class="string">&#x27;s&#x27;</span>, [value shortValue])</span><br><span class="line">                        ccm_future_success_block_case(<span class="string">&#x27;l&#x27;</span>, [value longValue])</span><br><span class="line">                        ccm_future_success_block_case(<span class="string">&#x27;q&#x27;</span>, [value longValue])</span><br><span class="line">                        ccm_future_success_block_case(<span class="string">&#x27;C&#x27;</span>, [value unsignedCharValue])</span><br><span class="line">                        ccm_future_success_block_case(<span class="string">&#x27;I&#x27;</span>, [value unsignedIntValue])</span><br><span class="line">                        ccm_future_success_block_case(<span class="string">&#x27;S&#x27;</span>, [value unsignedShortValue])</span><br><span class="line">                        ccm_future_success_block_case(<span class="string">&#x27;L&#x27;</span>, [value unsignedLongValue])</span><br><span class="line">                        ccm_future_success_block_case(<span class="string">&#x27;Q&#x27;</span>, [value unsignedLongLongValue])</span><br><span class="line">                        ccm_future_success_block_case(<span class="string">&#x27;f&#x27;</span>, [value floatValue])</span><br><span class="line">                        ccm_future_success_block_case(<span class="string">&#x27;d&#x27;</span>, [value doubleValue])</span><br><span class="line">                        ccm_future_success_block_case(<span class="string">&#x27;B&#x27;</span>, [value boolValue])</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)onFailure:(<span class="type">void</span>(^)(<span class="built_in">NSError</span> *))failureBlock &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> onComplete:^(<span class="built_in">NSError</span> *error, <span class="type">id</span> value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            failureBlock(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)tryExecuteCallbacks &#123;</span><br><span class="line">    [<span class="keyword">self</span>.dispatchQueue async:^&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.futureValue == <span class="literal">nil</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        __block <span class="type">id</span> value = <span class="keyword">self</span>.futureValue;</span><br><span class="line">        [<span class="keyword">self</span>.blocks enumerateObjectsUsingBlock:^(CCMFutureBlockWrapper block, <span class="built_in">NSUInteger</span> idx, <span class="type">BOOL</span> *stop) &#123;</span><br><span class="line">            block(value);</span><br><span class="line">        &#125;];</span><br><span class="line">       </span><br><span class="line">        [<span class="keyword">self</span>.blocks removeAllObjects];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">CCMFuture</span> (<span class="title">Private</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)success:(<span class="type">id</span>)value &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.futureValue != <span class="literal">nil</span>) &#123; <span class="keyword">return</span>; &#125; <span class="comment">// process duplicate set future value</span></span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.dispatchQueue async:^&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.futureValue != <span class="literal">nil</span>) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (value == <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="keyword">self</span>.futureValue = [<span class="built_in">NSNull</span> null];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.futureValue = value;</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="keyword">self</span> tryExecuteCallbacks];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)failure:(<span class="built_in">NSError</span> *)error &#123;</span><br><span class="line">    <span class="built_in">NSAssert</span>(error != <span class="literal">nil</span>, <span class="string">@&quot;error can not be a nil&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.futureValue != <span class="literal">nil</span>) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.dispatchQueue async:^&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.futureValue != <span class="literal">nil</span>) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.futureValue = error;</span><br><span class="line">        [<span class="keyword">self</span> tryExecuteCallbacks];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><figcaption><span>DispatchQueue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">CCMDispatchQueue</span> </span>&#123;</span><br><span class="line">    <span class="type">void</span> *queueTag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)main &#123;</span><br><span class="line">    <span class="keyword">static</span> CCMDispatchQueue *queue = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> pred;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;pred, ^&#123;</span><br><span class="line">        queue = [[<span class="keyword">self</span> alloc] initWithGCDQueue:dispatch_get_main_queue()];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)global &#123;</span><br><span class="line">    <span class="keyword">static</span> CCMDispatchQueue *queue = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> pred;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;pred, ^&#123;</span><br><span class="line">        queue = [[<span class="keyword">self</span> alloc] initWithGCDQueue:dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>)];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)serialQueueWithName:(<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] initWithName:name serial:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)concurrentQueueWithName:(<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] initWithName:name serial:<span class="literal">NO</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name serial:(<span class="type">BOOL</span>)serial &#123;</span><br><span class="line">    dispatch_queue_attr_t attr = serial ? DISPATCH_QUEUE_SERIAL : DISPATCH_QUEUE_CONCURRENT;</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create([name cStringUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>], attr);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> initWithGCDQueue:queue];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithGCDQueue:(<span class="built_in">dispatch_queue_t</span>)queue &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="variable language_">super</span> init]) &#123;</span><br><span class="line">        _underlyingQueue = queue;</span><br><span class="line">        queueTag = &amp;queueTag;</span><br><span class="line">        dispatch_queue_set_specific(_underlyingQueue, queueTag, queueTag, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)sync:(dispatch_block_t)block &#123;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> isCurrent]) &#123;</span><br><span class="line">        block();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">dispatch_sync</span>(<span class="keyword">self</span>.underlyingQueue, block);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)async:(dispatch_block_t)block &#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.underlyingQueue, block);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)barrierSync:(dispatch_block_t)block &#123;</span><br><span class="line">    <span class="keyword">if</span> (dispatch_get_specific(queueTag)) &#123;</span><br><span class="line">        block();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dispatch_barrier_sync(<span class="keyword">self</span>.underlyingQueue, block);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)barrierAsync:(dispatch_block_t)block &#123;</span><br><span class="line">    dispatch_barrier_async(<span class="keyword">self</span>.underlyingQueue, block);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)after:(<span class="built_in">NSTimeInterval</span>)delay block:(dispatch_block_t)block &#123;</span><br><span class="line">    <span class="keyword">if</span> (block == <span class="literal">nil</span>) <span class="keyword">return</span>;</span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(delay * <span class="built_in">NSEC_PER_SEC</span>)), <span class="keyword">self</span>.underlyingQueue, block);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">BOOL</span>)isCurrent &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.underlyingQueue == dispatch_get_main_queue()  &amp;&amp; [<span class="built_in">NSThread</span> isMainThread])</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> dispatch_get_specific(queueTag) != <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>在上面的代码里有个很基础的概念要清楚：<code>void(^)()</code>这种定义的 Block，并不是代码没有参数，而是可以指定任何参数。没有参数的 Block 定义是这样的：<code>void(^)(void)</code>，所以，上面我们要用<code>NSMethodSignature</code>来解析 Block 的参数个数和类型，这使得我们的客户端代码不用关注值类型的装箱&#x2F;拆箱（_比如NSInteger和NSNumber的转换_）。</p>
<p>为了方便使用到类似泛型的特性，我们还需要定义一个如下的宏：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CCMFutureOf(name) id<span class="string">&lt;CCMFutureOf##name&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCMFutureDef(name, type) \</span></span><br><span class="line"><span class="meta">@protocol CCMFutureOf##name <span class="string">&lt;NSObject&gt; \</span></span></span><br><span class="line"><span class="keyword">@required</span> \</span><br><span class="line"> \</span><br><span class="line">- (<span class="keyword">instancetype</span>)onComplete:(<span class="type">void</span>(^)(<span class="built_in">NSError</span> *, type))completeBlock; \</span><br><span class="line"> \</span><br><span class="line">- (<span class="keyword">instancetype</span>)onSuccess:(<span class="type">void</span>(^)(type))successBlock; \</span><br><span class="line"> \</span><br><span class="line">- (<span class="keyword">instancetype</span>)onFailure:(<span class="type">void</span>(^)(<span class="built_in">NSError</span> *))failureBlock; \</span><br><span class="line"> \</span><br><span class="line"><span class="keyword">@end</span> \</span><br></pre></td></tr></table></figure>

<p>所以可以这样使用咯：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CCMFutureDef(Int, <span class="built_in">NSInteger</span>)</span><br><span class="line">CCMFutureDef(String, <span class="built_in">NSString</span> *)</span><br><span class="line"></span><br><span class="line">- (CCMFutureOf(Int))requestUserCount &#123;</span><br><span class="line">    CCMPromise *promise = [CCMPromise new];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 模拟异步</span></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">        [promise successWithValue:@<span class="number">10</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> promise.dynamicFuture;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[[[xxx requestUserCount] onSuccess:^(<span class="built_in">NSInteger</span> value) &#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;] onFailure:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h2 id="接下来做什么"><a href="#接下来做什么" class="headerlink" title="接下来做什么"></a>接下来做什么</h2><p>Promise&amp;Future 很浪漫，很优雅，那么你是否可以考虑将自己网络请求相关的 API 尝试用这种方式来封装呢？</p>
<p>还有，我真的是名诗人，我叫李白。</p>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/2015/10/06/let-us-talk-about-the-im-architecture-again-part-c/" rel="bookmark">再谈 IM 架构设计（下）</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/2016/04/23/the-design-pattern-of-composite/" rel="bookmark">组合化繁为简的力量</a></div>
    </li>
  </ul>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Future/" rel="tag"># Future</a>
              <a href="/tags/Promise/" rel="tag"># Promise</a>
              <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag"># 设计模式</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2016/04/23/the-design-pattern-of-composite/" rel="prev" title="组合化繁为简的力量">
      <i class="fa fa-chevron-left"></i> 组合化繁为简的力量
    </a></div>
      <div class="post-nav-item">
    <a href="/2016/05/22/the-oop-thought-of-xcode-project-manage/" rel="next" title="从面向对象来理解 Xcode 的项目管理">
      从面向对象来理解 Xcode 的项目管理 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">1.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E4%BE%8B%E5%AD%90"><span class="nav-number">2.</span> <span class="nav-text">实际例子</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Objective-C-%E7%AE%80%E6%B4%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.</span> <span class="nav-text">Objective-C 简洁实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A5%E4%B8%8B%E6%9D%A5%E5%81%9A%E4%BB%80%E4%B9%88"><span class="nav-number">4.</span> <span class="nav-text">接下来做什么</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Makee"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Makee</p>
  <div class="site-description" itemprop="description">LIFE IS NOT EASY BUT HARD WORK ALWAYS PAYS.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/prinsun" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;prinsun" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/prinsun" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;prinsun" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Makee</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  
  <script data-pjax>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>















    <div id="pjax">
  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'FR2mSA60UEvzmYC24OgbdtvW-gzGzoHsz',
      appKey     : 'L70FAQa4gHBwVkjRwKJGajlx',
      placeholder: "欢迎留言交流...",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

    </div>
</body>
</html>

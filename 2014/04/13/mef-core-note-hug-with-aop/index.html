<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.png">
  <link rel="mask-icon" href="/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.makeex.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="最近推荐同事在项目中使用起了 MEF，用其构建一个插件式的多人开发框架，因为该框架不是让我去设计了，所以对于 MEF 和 IOC 等概念不是很了解的同事，便会出现各种问题。接入 AOP 便是其中的问题之一，看在大家都是一起工作的同事，能帮的我自然会尽量去帮，不过，过不了多久我就会离职了，所以，且行且珍惜吧。">
<meta property="og:type" content="article">
<meta property="og:title" content="MEF核心笔记（6）让 MEF 拥抱 AOP">
<meta property="og:url" content="http://blog.makeex.com/2014/04/13/mef-core-note-hug-with-aop/index.html">
<meta property="og:site_name" content="MakeeX">
<meta property="og:description" content="最近推荐同事在项目中使用起了 MEF，用其构建一个插件式的多人开发框架，因为该框架不是让我去设计了，所以对于 MEF 和 IOC 等概念不是很了解的同事，便会出现各种问题。接入 AOP 便是其中的问题之一，看在大家都是一起工作的同事，能帮的我自然会尽量去帮，不过，过不了多久我就会离职了，所以，且行且珍惜吧。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.makeex.com/images/2014/04/13/01.png">
<meta property="og:image" content="http://blog.makeex.com/images/2014/04/13/02.png">
<meta property="og:image" content="http://blog.makeex.com/images/2014/04/13/03.png">
<meta property="article:published_time" content="2014-04-13T14:29:56.000Z">
<meta property="article:modified_time" content="2015-09-29T08:33:20.000Z">
<meta property="article:author" content="Makee">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.makeex.com/images/2014/04/13/01.png">

<link rel="canonical" href="http://blog.makeex.com/2014/04/13/mef-core-note-hug-with-aop/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>MEF核心笔记（6）让 MEF 拥抱 AOP | MakeeX</title>
  


  <script data-pjax>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b46a193b288b66b7eb9dc75b4d74eae6";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">MakeeX</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/prinsun" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.makeex.com/2014/04/13/mef-core-note-hug-with-aop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Makee">
      <meta itemprop="description" content="LIFE IS NOT EASY BUT HARD WORK ALWAYS PAYS.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MakeeX">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MEF核心笔记（6）让 MEF 拥抱 AOP
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2014-04-13 22:29:56" itemprop="dateCreated datePublished" datetime="2014-04-13T22:29:56+08:00">2014-04-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/MEF/" itemprop="url" rel="index"><span itemprop="name">MEF</span></a>
                </span>
            </span>

          
            <span id="/2014/04/13/mef-core-note-hug-with-aop/" class="post-meta-item leancloud_visitors" data-flag-title="MEF核心笔记（6）让 MEF 拥抱 AOP" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">评论总数：</span>
    
    <a title="valine" href="/2014/04/13/mef-core-note-hug-with-aop/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2014/04/13/mef-core-note-hug-with-aop/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>最近推荐同事在项目中使用起了 MEF，用其构建一个插件式的多人开发框架，因为该框架不是让我去设计了，所以对于 MEF 和 IOC 等概念不是很了解的同事，便会出现各种问题。接入 AOP 便是其中的问题之一，看在大家都是一起工作的同事，能帮的我自然会尽量去帮，不过，过不了多久我就会离职了，所以，且行且珍惜吧。</p>
<span id="more"></span>

<h2 id="IOC-和-AOP-的概念"><a href="#IOC-和-AOP-的概念" class="headerlink" title="IOC 和 AOP 的概念"></a>IOC 和 AOP 的概念</h2><p>对于 IOC 和 AOP，这应该又算是一个老生常谈的问题，相应的说明和资料比比皆是，所以，我在这里也不多做讲解，只是概括性的总结下。</p>
<ul>
<li><strong>IOC</strong>：从英文意思来说，叫“控制反转”，即原来我们的各种操作只能依赖于抽象的具体实现，而通过 DI（依赖注入），我们的操作只依赖于抽象本身，具体实现是在运行时动态注入的。这样我们的依赖被倒置了，这就是 IOC，它不是组件和框架，它是设计模式上的东西。</li>
<li><strong>AOP</strong>：从英文意思来说，叫“面向切面编程”。在面向对象的编程里，正常情况下，我们代码的执行顺序都是纵向的，即由一个个类中的方法顺序执行。而切面，便是垂直于纵向的一面，即贯穿顺序执行中的每个单元。AOP 便是让我们从切面的角度来书写代码，而这些代码大多数都是贯穿于系统中很多类和方法中，比如日志记录、异常处理、权限控制等。AOP 和 IOC 类似，它也是设计层的东西，并不是一个实际的组件或框架。</li>
</ul>
<h2 id="扩展-MEF，使其支持-AOP"><a href="#扩展-MEF，使其支持-AOP" class="headerlink" title="扩展 MEF，使其支持 AOP"></a>扩展 MEF，使其支持 AOP</h2><p>其实 IOC 和 AOP 真的是很好的朋友，以至于很多 IOC 的框架里原生就支持 AOP，因为 IOC 在运行时注入具体实现的时候，便是创建代理对象的最佳时机。当然，在 MEF 里，获取导出（Export）时，便是创建代理对象的契机。这里反复提及的代理对象，是目前 .NET 中实现 AOP 的一种手段。据我所知，在 .NET 中目前大体有以下两种 AOP 的实现方式：</p>
<p><strong>动态代理</strong>：在运行时，动态的创建某个类或对象的代理，在代理中重写目标类（被创建成代理的类）的虚方法（可重写的方法），从而在调用代理对象的方法时，执行特定的切面代码。目前圈子里大多数实现都是使用 Emit 来动态构建一个代理类，也有使用 Dynamic 来构建的（注：这种方式并不是重写虚方法，有兴趣的同学可以查看<a target="_blank" rel="noopener" href="http://www.cnblogs.com/niceWk/archive/2010/07/19/1780843.html">NiceWk同学的文章</a>）。动态代理的好处是实现起来简单，缺点便是要拦截（插入切面代码）的方法或属性必须申明为可重写的，如果你可以容忍，那么你可以选择这种方式。</p>
<p>使用动态代理构建的AOP框架：<a target="_blank" rel="noopener" href="http://www.castleproject.org/">Castle Dynamic Proxy</a> ，<a target="_blank" rel="noopener" href="http://unity.codeplex.com/">Unity</a>，<a target="_blank" rel="noopener" href="http://www.rapier-loom.net/">LOOM.NET</a> 等</p>
<p><strong>IL 编织</strong>：这种实现方式并不是在运行时，而是在程序集编译时或生成完毕后，在目标方法中，织入切面代码对应的 IL。目前这种实现方式，大多数是对编译器的扩展，或者是在生成完毕后加入后续的一个处理过程。IL 编织可以将 AOP 运行时的性能损耗降到最小，并且目标类中不需要定义虚方法，缺点是实现起来比较复杂，调试起来也不方便。</p>
<p>使用IL编织的AOP框架：<a target="_blank" rel="noopener" href="http://www.postsharp.net/">Postsharp</a>（收费），<a target="_blank" rel="noopener" href="http://www.cs.virginia.edu/~eos">Eos</a>，<a target="_blank" rel="noopener" href="http://www.codeproject.com/Articles/23333/Introducing-LinFu-Part-VI-LinFu-AOP-Pervasive-Meth">LinFu.AOP</a> 等</p>
<p>如果是使用 IL 编织的 AOP 框架，那么对于 MEF 而言，是不需要做任何扩展操作即可使用的，原因很简单，MEF 最后发现的导出，必定是已经完成 IL 编织的类的实例。而动态代理不同，动态代理必须要有一个创建代理的过程。这里所说的扩展 MEF，便是让 MEF 将这个过程自动化的去执行，以便我们获取到的导出便已是我们想要的代理。</p>
<p>对于代理，它有两种方式，一种是类的代理，一种是对象的代理，它和适配器模式、装饰者模式很相识（_可笑的是最近一次面试中，技术官问我适配器模式中“类适配”和“对象适配”的区别时，我尽然没答上来，果然技术不用则退，脑袋也也一样，各位同学一起铭记啊_）。所谓类代理，便是在创建时，直接创建的便是目标类的代理类，代理类中不会包含目标类的实例；对象代理，便是使用了装饰者模式，代理类中包含目标类的实例，代理类只是做了一层装饰。以下是这两种代理的简要代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 目标类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TargetClass</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Method</span>()</span> &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类代理</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ClassProxy</span> : <span class="title">TargetClass</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Method</span>()</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment">// ...</span></span><br><span class="line">       <span class="keyword">base</span>.Method();</span><br><span class="line">       <span class="comment">// ...</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对象代理</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ObjectProxy</span> : <span class="title">TargetClass</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">private</span> TargetClass _targetObj;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ObjectProxy</span>(<span class="params">TargetClass targetObj</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       _targetObj = targetObj;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Method</span>()</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment">// ...</span></span><br><span class="line">       _targetObj.Method();</span><br><span class="line">       <span class="comment">// ...</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建上面代理的代码如下，各位同学应该很容易看出它们的区别：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> clsProxy = <span class="keyword">new</span> ClassProxy();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> targetObj = <span class="keyword">new</span> TargetClass();</span><br><span class="line"><span class="keyword">var</span> objProxy = <span class="keyword">new</span> ObjectProxy(targetObj);</span><br></pre></td></tr></table></figure>

<p>理解这两种代理的不同是很重要的，这关系到我们选择何种 AOP 实现方式，对于 MEF 的扩展，我还是推荐使用对象代理的方式，原因也很简单，因为我们可以直接在 MEF 获取导出后，对导出进行一个处理，这样实现起来比较简单，如果使用类代理的话，我们需要深入到 MEF 对象创建，这可能比较麻烦。如何对导出进行一个后处理呢？这相当简单，我们只要继承<a target="_blank" rel="noopener" href="http://technet.microsoft.com/zh-cn/library/system.componentmodel.composition.hosting.compositioncontainer(v=vs.95).aspx">CompositionContainer</a>，重写它的<code>GetExportsCore</code>，现实我们自己的 Container 即可：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AOPCompositionContainer</span> : <span class="title">CompositionContainer</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="meta">#<span class="keyword">region</span> ctor</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">AOPCompositionContainer</span>()</span></span><br><span class="line"><span class="function">       : <span class="title">base</span>()</span> &#123; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">AOPCompositionContainer</span>(<span class="params"><span class="keyword">params</span> ExportProvider[] providers</span>)</span></span><br><span class="line"><span class="function">       : <span class="title">base</span>(<span class="params">providers</span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">AOPCompositionContainer</span>(<span class="params">ComposablePartCatalog catalog, <span class="keyword">params</span> ExportProvider[] providers</span>)</span></span><br><span class="line"><span class="function">       : <span class="title">base</span>(<span class="params">catalog, providers</span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">AOPCompositionContainer</span>(<span class="params">ComposablePartCatalog catalog, <span class="built_in">bool</span> isThreadSafe, <span class="keyword">params</span> ExportProvider[] providers</span>)</span></span><br><span class="line"><span class="function">       : <span class="title">base</span>(<span class="params">catalog, isThreadSafe, providers</span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> IEnumerable&lt;Export&gt; <span class="title">GetExportsCore</span>(<span class="params">ImportDefinition definition, AtomicComposition atomicComposition</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">var</span> exports = <span class="keyword">base</span>.GetExportsCore(definition, atomicComposition);</span><br><span class="line">       <span class="keyword">return</span> exports.Select(GetAopExportCore);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> Export <span class="title">GetAopExportCore</span>(<span class="params">Export export</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">if</span> (!export.Metadata.ContainsKey(<span class="string">&quot;AOPEnabled&quot;</span>))</span><br><span class="line">           <span class="keyword">return</span> export;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">var</span> aspectsEnabled = export.Metadata[<span class="string">&quot;AOPEnabled&quot;</span>];</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> ((<span class="built_in">bool</span>)aspectsEnabled == <span class="literal">false</span>)</span><br><span class="line">           <span class="keyword">return</span> export;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Export(export.Definition, () =&gt; Aop.ProxyGenerator.CreateProxy(<span class="keyword">this</span>, export.Value));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>代码相当的简单，我们在获取到导出后，对导出逐个的进行了一个后处理，我们判定导出的元数据中是否包含<code>AOPEnabled</code>，如果有，且该值为<code>true</code>，则返回使用<code>ProxyGenerator</code>创建的代理构建的导出，否则直接返回原始获取到的导出。这里使用到了导出的元数据，不清楚的同学，可以看<a target="_blank" rel="noopener" href="http://prinsun.github.io/blog/2013/04/09/mef-core-note-attribute-part-b/">先前的博文</a>记录，如此一来，如果我们想导出自动为代理的话，就必须在导出时指定<code>AOPEnabled</code>元数据，并且要设置为<code>true</code>。还有其它的实现方式么？有！我们可以拿 <code>export</code>的<code>Value</code>来做文章，通过<code>export</code>的<code>Value</code>，我们可以反射获取到导出对象的类型，通过类型我们就可以反射获取到是否有做什么特殊的<code>Attribute</code>标记，可能说得不是很清晰，那么下面这段代码是另外一种选择：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> Export <span class="title">GetAopExportCore</span>(<span class="params">Export export</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> aopEnabledAttr = export.Value.GetType().GetCustomAttributes(<span class="keyword">typeof</span>(AopEnabledAttribute), <span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">if</span> (aopEnabledAttr == <span class="literal">null</span> || aopEnabledAttr.Length == <span class="number">0</span>) <span class="keyword">return</span> export;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Export(export.Definition, () =&gt; Aop.ProxyGenerator.CreateProxy(<span class="keyword">this</span>, export.Value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相比这两种实现，我推荐使用元数据实现的方式，原因很简单，因为少去了一次反射消耗，毕竟在当前代码块里，元数据是已经完成解析了的，不用也是浪费。为了方便后续的使用，我们自定义两种带元数据导出的<code>ExportAttribute</code>：</p>
<p><strong>AOPExportAttribute</strong>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 支持 AOP 的导出</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">MetadataAttribute</span>]</span><br><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.Class, AllowMultiple = false, Inherited = false)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AOPExportAttribute</span> : <span class="title">ExportAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="meta">#<span class="keyword">region</span> ctor</span></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">AOPExportAttribute</span>() : <span class="title">base</span>()</span> &#123; <span class="keyword">this</span>.AOPEnabled = <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">AOPExportAttribute</span>(<span class="params"><span class="built_in">string</span> contractName</span>) : <span class="title">base</span>(<span class="params">contractName</span>)</span> &#123; <span class="keyword">this</span>.AOPEnabled = <span class="literal">true</span>; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">AOPExportAttribute</span>(<span class="params">Type contractType</span>) : <span class="title">base</span>(<span class="params">contractType</span>)</span> &#123; <span class="keyword">this</span>.AOPEnabled = <span class="literal">true</span>; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">AOPExportAttribute</span>(<span class="params"><span class="built_in">string</span> contractName, Type contractType</span>) : <span class="title">base</span>(<span class="params">contractName, contractType</span>)</span> &#123; <span class="keyword">this</span>.AOPEnabled = <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 是否启用 AOP</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   [<span class="meta">DefaultValue(true)</span>]</span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">bool</span> AOPEnabled &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>InheritedAOPExportAttribute</strong>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 支持 AOP 的导出，且子类也继承该设定 </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">MetadataAttribute</span>]</span><br><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.Class | AttributeTargets.Interface, AllowMultiple = false, Inherited = true)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InheritedAOPExportAttribute</span> : <span class="title">InheritedExportAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="meta">#<span class="keyword">region</span> ctor</span></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">InheritedAOPExportAttribute</span>() : <span class="title">base</span>()</span> &#123; <span class="keyword">this</span>.AOPEnabled = <span class="literal">true</span>; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">InheritedAOPExportAttribute</span>(<span class="params"><span class="built_in">string</span> contractName</span>) : <span class="title">base</span>(<span class="params">contractName</span>)</span> &#123; <span class="keyword">this</span>.AOPEnabled = <span class="literal">true</span>; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">InheritedAOPExportAttribute</span>(<span class="params">Type contractType</span>) : <span class="title">base</span>(<span class="params">contractType</span>)</span> &#123; <span class="keyword">this</span>.AOPEnabled = <span class="literal">true</span>; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">InheritedAOPExportAttribute</span>(<span class="params"><span class="built_in">string</span> contractName, Type contractType</span>) : <span class="title">base</span>(<span class="params">contractName, contractType</span>)</span> &#123; <span class="keyword">this</span>.AOPEnabled = <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 是否启用 AOP</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   [<span class="meta">DefaultValue(true)</span>]</span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">bool</span> AOPEnabled &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两段实现都很简单，只是作为<code>ExportAttribute</code> 、 <code>InheritedExportAttribute</code> 的AOP替代版本。</p>
<h2 id="简单的-AOP-框架实现"><a href="#简单的-AOP-框架实现" class="headerlink" title="简单的 AOP 框架实现"></a>简单的 AOP 框架实现</h2><p>在上面我们扩展 MEF 时，有使用到<code>ProxyGenerator</code>来创建代理，这便是我们 AOP 最核心的部分，你完全可以使用其它第三方AOP框架来实现这个<code>ProxyGenerator</code>，但这里我选择自己通过 Emit 来实现一个简单的 AOP 框架。主要是为了学习，也不想引入太多太复杂的框架，简单实用才是最好的，实现上有借鉴 Castle ，当然，我不可能比它做得更好。</p>
<p>首先我们仿照Caslte，定义如下一个拦截器的公共接口：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 拦截器</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IInterceptor</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 执行拦截方法</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;invocation&quot;&gt;</span>拦截的一些上下文信息<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">Intercept</span>(<span class="params">IInvocation invocation</span>)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 拦截器的执行顺序</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="built_in">int</span> Order &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即，我们所有的切面代码，都是在<code>Intercept</code>这里执行， <code>Intercept</code>会提供执行时的一些上下文信息，即<code>IInvocation</code>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 拦截时的一些信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IInvocation</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 获取拦截方法的参数列表</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="built_in">object</span>[] Arguments &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 获取拦截方法的泛型参数</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   Type[] GenericArguments &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 获取拦截方法的信息</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   MethodInfo Method &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 获取代理对象</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="built_in">object</span> Proxy &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 被创建成代理的对象，即原始对象</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="built_in">object</span> Target &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 获取或设定返回值</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="built_in">object</span> ReturnValue &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 获取目标类型，即被拦截的类型（非代理类型）</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   Type TargetType &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 获取指定所以的参数值</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;index&quot;&gt;</span>参数索引<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>返回指定的参数值，或者抛出异常<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;IndexOutOfRangeException&quot;&gt;</span>IndexOutOfRangeException<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">   <span class="function"><span class="built_in">object</span> <span class="title">GetArgumentValue</span>(<span class="params"><span class="built_in">int</span> index</span>)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 设定指定索引的参数值</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;index&quot;&gt;</span>参数索引<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span>要设定的值<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;IndexOutOfRangeException&quot;&gt;</span>IndexOutOfRangeException<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">SetArgumentValue</span>(<span class="params"><span class="built_in">int</span> index, <span class="built_in">object</span> <span class="keyword">value</span></span>)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 执行下一个拦截器，如果没有拦截器了，则执行被拦截的方法</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">Proceed</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体方法的作用，熟悉 Castle 的应该都很清楚，我这里做了些许简化，即便你不熟悉，我的注释也写得很清晰。需要特别注意的是 Proceed 这个方法，如果在某一个拦截器中未执行该方法，则目标方法就不会得到调用，如果该目标方法有返回值，而目前的 ReturnValue 为 <code>null</code>的话，则会抛出异常。</p>
<p>有了这两个核心接口定以后，我们就应该考虑代理是如何来实现了，在我们使用 Emit 来构建代理的时候，我推荐的做法是先用 C# 代码手动写出这样一个代理，然后通过反编译工具（ILDasm、ILSpy 等）反编译成 MSIL 后，对照着用 Emit 来实现。那么我们先手动写一个代理：</p>
<p><strong>目标类（Target Class）</strong>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Target</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Method</span>(<span class="params"><span class="built_in">string</span> a, <span class="built_in">bool</span> b</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>代理类（Proxy Class）</strong>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Proxy</span> : <span class="title">Target</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">private</span> Target _target;</span><br><span class="line">   <span class="keyword">private</span> IInterceptor[] _interceptors;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Proxy</span>(<span class="params">Target target, IInterceptor[] interceptors</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       _target = target;</span><br><span class="line">       _interceptors = interceptors;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Method</span>(<span class="params"><span class="built_in">string</span> a, <span class="built_in">bool</span> b</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="built_in">object</span>[] arguments = <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; a, b &#125;;</span><br><span class="line">       Type[] argumentTypes = <span class="keyword">new</span> Type[] &#123; a.GetType(), b.GetType() &#125;;</span><br><span class="line">       MethodInfo method = ReflectionHelper.GetMethod(_target.GetType(), <span class="string">&quot;Method&quot;</span>, argumentTypes, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">var</span> invocation = <span class="keyword">new</span> Invocation(_target, <span class="keyword">this</span>, method, arguments, _interceptors);</span><br><span class="line"></span><br><span class="line">       invocation.Proceed();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代理类大体就如上面，可以看出使用的是对象代理，但在实际的 Emit 中也有些不同，我们还需要注意返回值和泛型等问题。值得一提的是，我们为了方便 Emit，所以故意将很多代码写得很朴实，这样在反编译参照时才有价值。在这里，我们将方法的最终调用都放给<code>Invocation</code>的<code>Proceed</code>去处理了（如果放在代理里面，Emit 起来太复杂），<code>Invocation</code>的实现如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Invocation</span> : <span class="title">IInvocation</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="built_in">object</span> _target;</span><br><span class="line">   <span class="keyword">private</span> <span class="built_in">object</span> _proxy;</span><br><span class="line">   <span class="keyword">private</span> MethodInfo _method;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> List&lt;<span class="built_in">object</span>&gt; _arguments;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> Queue&lt;Action&lt;IInvocation&gt;&gt; _invokeQuery;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Invocation</span>(<span class="params"><span class="built_in">object</span> target, <span class="built_in">object</span> proxy, MethodInfo method, <span class="built_in">object</span>[] arguments, IInterceptor[] interceptors</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       _target = target;</span><br><span class="line">       _proxy = proxy;</span><br><span class="line">       _method = method;</span><br><span class="line"></span><br><span class="line">       _arguments = <span class="keyword">new</span> List&lt;<span class="built_in">object</span>&gt;(arguments);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       _invokeQuery = <span class="keyword">new</span> Queue&lt;Action&lt;IInvocation&gt;&gt;();</span><br><span class="line">       <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> interceptors)</span><br><span class="line">           _invokeQuery.Enqueue(x =&gt; item.Intercept(x));</span><br><span class="line"></span><br><span class="line">       _invokeQuery.Enqueue(x =&gt; x.ReturnValue = Method.Invoke(Target, Arguments));</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">object</span>[] Arguments</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">get</span> &#123; <span class="keyword">return</span> _arguments.ToArray(); &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> Type[] GenericArguments</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">get</span> &#123; <span class="keyword">return</span> _method.GetGenericArguments(); &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> MethodInfo Method</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">get</span> &#123; <span class="keyword">return</span> _method; &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">object</span> Proxy</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">get</span> &#123; <span class="keyword">return</span> _proxy; &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">object</span> Target</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">get</span> &#123; <span class="keyword">return</span> _target; &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">object</span> ReturnValue &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> Type TargetType</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">get</span> &#123; <span class="keyword">return</span> _target.GetType(); &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="built_in">object</span> <span class="title">GetArgumentValue</span>(<span class="params"><span class="built_in">int</span> index</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">return</span> _arguments[index];</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetArgumentValue</span>(<span class="params"><span class="built_in">int</span> index, <span class="built_in">object</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       _arguments[index] = <span class="keyword">value</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Proceed</span>()</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">if</span> (_invokeQuery.Count &gt; <span class="number">0</span>)</span><br><span class="line">           _invokeQuery.Dequeue().Invoke(<span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们将所有<code>IInterceptor</code>中的<code>Intercept</code>方法包装成<code>Action&lt;IInvocation&gt;</code>按顺序存放到一个队列里面了，并将目标方法的调用放到了队列最后。在<code>Proceed</code>方法里，我们出队，并对方法进行了调用，所以，只要有一个拦截器未对<code>Proceed</code>进行调用，那么我们就无法执行到目标方法。针对这样的一个设计，我们的代理类就变得比较简单，这也方便我们使用 Emit 来构建，毕竟用 Emit 来构建复杂逻辑还是很繁琐的。</p>
<p>那么现在就来揭开<code>ProxyGenerator</code>这个静态类的神秘面纱吧，首先是<code>CreateProxy</code>方法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建对象的代理</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;obj&quot;&gt;</span>要创建代理的对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>创建完成的代理<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">object</span> <span class="title">CreateProxy</span>(<span class="params">AOPCompositionContainer container, <span class="built_in">object</span> obj</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> attrs = obj.GetType().GetCustomAttributes(<span class="keyword">typeof</span>(IInterceptor), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (attrs == <span class="literal">null</span> || attrs.Length == <span class="number">0</span>) <span class="keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> interceptors = attrs.Select(x =&gt; &#123; container.ComposeParts(x); <span class="keyword">return</span> (IInterceptor)x; &#125;)</span><br><span class="line">      .OrderBy(x =&gt; x.Order)</span><br><span class="line">      .ToArray();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> CreateProxy(obj, interceptors);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过代码，我们很容易就看出来，<code>IInterceptor</code>最终是以<code>CustomAttribute</code>的形式标记在需要拦截的类上的，并且我们对获取到的<code>IInterceptor</code>还做了一次<code>ComposeParts</code>，这样一来，我们可以在实现<code>IInterceptor</code>时使用<code>Import</code>来导入依赖。接下来，我们再看该方法的一个内部重载版本，即该方法最后<code>return</code>的那个调用：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">object</span> <span class="title">CreateProxy</span>(<span class="params"><span class="built_in">object</span> target, IInterceptor[] interceptors</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> targetType = target.GetType();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!_proxyTypeCache.ContainsKey(targetType))</span><br><span class="line">      _proxyTypeCache[targetType] = GenerateProxyType(targetType);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Activator.CreateInstance(_proxyTypeCache[targetType], target, interceptors);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>_proxyTypeCache</code>是一个简单<code>ConcurrentDictionary&lt;Type, Type&gt;</code>用来做代理类型的缓存，这样不必每次都去 Emit 一个代理类型，所以，核心的 Emit 部分都在<code>GenerateProxyType</code>这个方法里了：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据目标类型，生成代理类型</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;targetType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Type <span class="title">GenerateProxyType</span>(<span class="params">Type targetType</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> assemblyName = <span class="keyword">new</span> AssemblyName(<span class="string">&quot;System.ComponentModel.Composition.Aop.Proxies&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">  <span class="keyword">var</span> assemblyDef = AppDomain.CurrentDomain.DefineDynamicAssembly(assemblyName, AssemblyBuilderAccess.RunAndSave);</span><br><span class="line">  <span class="keyword">var</span> moduleDef = assemblyDef.DefineDynamicModule(assemblyName.Name, <span class="string">&quot;System.ComponentModel.Composition.Aop.Proxies.dll&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> assemblyDef = AppDomain.CurrentDomain.DefineDynamicAssembly(assemblyName, AssemblyBuilderAccess.Run);</span><br><span class="line">  <span class="keyword">var</span> moduleDef = assemblyDef.DefineDynamicModule(assemblyName.Name);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 继承至 targetType 的一个代理类型</span></span><br><span class="line">  <span class="keyword">var</span> typeDef = moduleDef.DefineType(targetType.FullName + <span class="string">&quot;__Proxy&quot;</span>, TypeAttributes.Public, targetType);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> context = <span class="keyword">new</span> EmitContext(targetType, typeDef);</span><br><span class="line"></span><br><span class="line">  EmitProxyTypeCustomeAttributes(context);</span><br><span class="line">  EmitProxyTypeFields(context);</span><br><span class="line">  EmitProxyTypeConstructor(context);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> targetMethods = targetType.GetMethods();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="keyword">var</span> method <span class="keyword">in</span> targetMethods)</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">if</span> (method.IsFinal) <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">if</span> (!method.IsVirtual &amp;&amp; !method.IsAbstract) <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">if</span> (method.Name == <span class="string">&quot;ToString&quot;</span>) <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">if</span> (method.Name == <span class="string">&quot;GetHashCode&quot;</span>) <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">if</span> (method.Name == <span class="string">&quot;Equals&quot;</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">      EmitProxyTypeMethod(context, method);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> result = typeDef.CreateType();</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">  assemblyDef.Save(<span class="string">&quot;System.ComponentModel.Composition.Aop.Proxies.dll&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对于 Emit 或则 MSIL 不熟悉的同学，推荐去看<a target="_blank" rel="noopener" href="http://www.cnblogs.com/Leo_wl/archive/2010/07/10/1774954.html">这一篇博文</a>，上面的方法里，我们加了一个预编译指令，这是为了方便调试，在 Debug 模式下会把 Emit 生成的程序集保存到文件，这样可以使用反编译工具查看是否构建的是自己所期望的。上面代码里，在构建代理的时候，主要是这样几个步骤：</p>
<ol>
<li>创建代理类型</li>
<li>设定代理类型的<code>CustomAttribute</code></li>
<li>构建代理类型的成员字段</li>
<li>构建代理类型的构造函数</li>
<li>构建代理方法</li>
</ol>
<p>值得一提的是，在 Emit 的过程中，为了方便参数和构建结果的传递，我们还是简单的定义了一个<code>EmitContext</code>类：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">EmitContext</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">EmitContext</span>(<span class="params">Type baseType, TypeBuilder typeBuilder</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">this</span>.BaseType = baseType;</span><br><span class="line">       <span class="keyword">this</span>.TypeBuilder = typeBuilder;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> Type BaseType &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> TypeBuilder TypeBuilder &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">readonly</span> Dictionary&lt;<span class="built_in">string</span>, FieldBuilder&gt; _fields = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, FieldBuilder&gt;();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> Dictionary&lt;<span class="built_in">string</span>, FieldBuilder&gt; FieldBuilders &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> _fields; &#125; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设定代理类型的<strong>CustomAttribute</strong>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">EmitProxyTypeCustomeAttributes</span>(<span class="params">EmitContext context</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> constructorInfo = <span class="keyword">typeof</span>(System.ComponentModel.Composition.PartNotDiscoverableAttribute)</span><br><span class="line">      .GetConstructor(Type.EmptyTypes);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> customAttributeBuilder = <span class="keyword">new</span> CustomAttributeBuilder(constructorInfo, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置 PartNotDiscoverableAttribute， 使得代理不会被 MEF 找到</span></span><br><span class="line">  context.TypeBuilder.SetCustomAttribute(customAttributeBuilder);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构建代理类型的成员字段：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">EmitProxyTypeFields</span>(<span class="params">EmitContext context</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  context.FieldBuilders[<span class="string">&quot;__obj&quot;</span>] = context.TypeBuilder.DefineField(<span class="string">&quot;__obj&quot;</span>, <span class="keyword">typeof</span>(<span class="built_in">object</span>), FieldAttributes.Private);</span><br><span class="line">  context.FieldBuilders[<span class="string">&quot;__interceptors&quot;</span>] = context.TypeBuilder.DefineField(<span class="string">&quot;__interceptors&quot;</span>, <span class="keyword">typeof</span>(IInterceptor[]), FieldAttributes.Private);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们将构建好的字段，存进了<code>EmitContext</code>，因为后面我们赋值和取值时会用到。</p>
<p>构建代理类型的构造函数：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">EmitProxyTypeConstructor</span>(<span class="params">EmitContext context</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> ctorDef = context.TypeBuilder.DefineConstructor(MethodAttributes.Public, CallingConventions.Standard,</span><br><span class="line">      <span class="keyword">new</span> Type[] &#123; context.BaseType, <span class="keyword">typeof</span>(IInterceptor[]) &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> il = ctorDef.GetILGenerator();</span><br><span class="line"></span><br><span class="line">  il.Emit(OpCodes.Ldarg_0);</span><br><span class="line">  il.Emit(OpCodes.Call, context.BaseType.GetConstructor(Type.EmptyTypes));</span><br><span class="line">  il.Emit(OpCodes.Ldarg_0);</span><br><span class="line">  il.Emit(OpCodes.Ldarg_1);</span><br><span class="line">  il.Emit(OpCodes.Stfld, context.FieldBuilders[<span class="string">&quot;__obj&quot;</span>]);</span><br><span class="line">  il.Emit(OpCodes.Ldarg_0);</span><br><span class="line">  il.Emit(OpCodes.Ldarg_2);</span><br><span class="line">  il.Emit(OpCodes.Stfld, context.FieldBuilders[<span class="string">&quot;__interceptors&quot;</span>]);</span><br><span class="line"></span><br><span class="line">  il.Emit(OpCodes.Ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在构造函数里，我们对成员字段进行了赋值操作，即把构造函数的参数，赋值给了相应的成员变量。</p>
<p>构建代理方法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Type VoidType = Type.GetType(<span class="string">&quot;System.Void&quot;</span>);</span><br><span class="line"><span class="comment">// Emit 拦截的方法，必须为 virtual 或 abstract</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">EmitProxyTypeMethod</span>(<span class="params">EmitContext context, MethodInfo method</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> parameterInfos = method.GetParameters();</span><br><span class="line">  <span class="keyword">var</span> parameterTypes = parameterInfos.Select(p =&gt; p.ParameterType).ToArray();</span><br><span class="line">  <span class="keyword">var</span> parameterLength = parameterTypes.Length;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> hasResult = method.ReturnType != VoidType;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> methodBuilder = context.TypeBuilder.DefineMethod(method.Name,</span><br><span class="line">      MethodAttributes.Public | MethodAttributes.Final | MethodAttributes.Virtual,</span><br><span class="line">      method.ReturnType, parameterTypes);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (method.IsGenericMethod)</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="comment">// 简单支持泛型，未配置泛型约束</span></span><br><span class="line">      methodBuilder.DefineGenericParameters(method.GetGenericArguments().Select(x =&gt; x.Name).ToArray());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> il = methodBuilder.GetILGenerator();</span><br><span class="line"></span><br><span class="line">  il.DeclareLocal(<span class="keyword">typeof</span>(<span class="built_in">object</span>[]));   <span class="comment">// arguments</span></span><br><span class="line">  il.DeclareLocal(<span class="keyword">typeof</span>(Type[]));     <span class="comment">// argumentTypes</span></span><br><span class="line">  il.DeclareLocal(<span class="keyword">typeof</span>(MethodInfo)); <span class="comment">// method</span></span><br><span class="line">  il.DeclareLocal(<span class="keyword">typeof</span>(Invocation)); <span class="comment">// invocation</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (method.IsGenericMethod) <span class="comment">// 定义泛型参数的实际类型</span></span><br><span class="line">  &#123;</span><br><span class="line">      il.DeclareLocal(<span class="keyword">typeof</span>(Type[]));     <span class="comment">// genericTypes</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> genericArguments = methodBuilder.GetGenericArguments();</span><br><span class="line"></span><br><span class="line">      il.Emit(OpCodes.Ldc_I4, genericArguments.Length);</span><br><span class="line">      il.Emit(OpCodes.Newarr, <span class="keyword">typeof</span>(Type));</span><br><span class="line">      il.Emit(OpCodes.Stloc_S, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; genericArguments.Length; i++)</span><br><span class="line">      &#123;</span><br><span class="line">          il.Emit(OpCodes.Ldloc_S, <span class="number">4</span>);</span><br><span class="line">          il.Emit(OpCodes.Ldc_I4, i);</span><br><span class="line">          il.Emit(OpCodes.Ldtoken, genericArguments[i]);</span><br><span class="line">          il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Type).GetMethod(<span class="string">&quot;GetTypeFromHandle&quot;</span>, <span class="keyword">new</span> Type[] &#123; <span class="keyword">typeof</span>(RuntimeTypeHandle) &#125;));</span><br><span class="line">          il.Emit(OpCodes.Stelem_Ref);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// arguments = new object[parameterLength]</span></span><br><span class="line">  il.Emit(OpCodes.Ldc_I4, parameterLength);</span><br><span class="line">  il.Emit(OpCodes.Newarr, <span class="keyword">typeof</span>(<span class="built_in">object</span>));</span><br><span class="line">  il.Emit(OpCodes.Stloc_0);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//argumentTypes = new Type[parameterLength]</span></span><br><span class="line">  il.Emit(OpCodes.Ldc_I4, parameterLength);</span><br><span class="line">  il.Emit(OpCodes.Newarr, <span class="keyword">typeof</span>(Type));</span><br><span class="line">  il.Emit(OpCodes.Stloc_1);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; parameterLength; i++)</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="comment">// arguments[i] = arg[i]</span></span><br><span class="line">      il.Emit(OpCodes.Ldloc_0);</span><br><span class="line">      il.Emit(OpCodes.Ldc_I4, i);</span><br><span class="line">      il.Emit(OpCodes.Ldarg, i + <span class="number">1</span>);  <span class="comment">// arg[0] == this</span></span><br><span class="line">      <span class="keyword">if</span> (parameterTypes[i].IsValueType || parameterTypes[i].IsGenericParameter)</span><br><span class="line">          il.Emit(OpCodes.Box, parameterTypes[i]);</span><br><span class="line">      il.Emit(OpCodes.Stelem_Ref);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// argumentTypes[i] = arg[i].GetType()</span></span><br><span class="line">      il.Emit(OpCodes.Ldloc_1);</span><br><span class="line">      il.Emit(OpCodes.Ldc_I4, i);</span><br><span class="line">      il.Emit(OpCodes.Ldarg, i + <span class="number">1</span>);  <span class="comment">// arg[0] == this</span></span><br><span class="line">      <span class="keyword">if</span> (parameterTypes[i].IsValueType || parameterTypes[i].IsGenericParameter)</span><br><span class="line">          il.Emit(OpCodes.Box, parameterTypes[i]);</span><br><span class="line">      il.Emit(OpCodes.Callvirt, <span class="keyword">typeof</span>(<span class="built_in">object</span>).GetMethod(<span class="string">&quot;GetType&quot;</span>));</span><br><span class="line">      il.Emit(OpCodes.Stelem_Ref);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// method =  ReflectionHelper.GetMethod(this.__obj.GetType(), &quot;TestMethod&quot;, array2, true);</span></span><br><span class="line">  il.Emit(OpCodes.Ldarg_0);</span><br><span class="line">  il.Emit(OpCodes.Ldfld, context.FieldBuilders[<span class="string">&quot;__obj&quot;</span>]);</span><br><span class="line">  il.Emit(OpCodes.Callvirt, context.BaseType.GetMethod(<span class="string">&quot;GetType&quot;</span>));</span><br><span class="line">  il.Emit(OpCodes.Ldstr, method.Name);</span><br><span class="line">  il.Emit(OpCodes.Ldloc_1);</span><br><span class="line">  <span class="keyword">if</span> (method.IsGenericMethod)</span><br><span class="line">      il.Emit(OpCodes.Ldc_I4_1);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">      il.Emit(OpCodes.Ldc_I4_0);</span><br><span class="line">  il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(ReflectionHelper).GetMethod(<span class="string">&quot;GetMethod&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (method.IsGenericMethod)</span><br><span class="line">  &#123;</span><br><span class="line">      il.Emit(OpCodes.Ldloc_S, <span class="number">4</span>);</span><br><span class="line">      il.Emit(OpCodes.Callvirt, <span class="keyword">typeof</span>(MethodInfo).GetMethod(<span class="string">&quot;MakeGenericMethod&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  il.Emit(OpCodes.Stloc_2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// invocation = new Invocation(_obj, this, method, arguments, _interceptors)</span></span><br><span class="line">  il.Emit(OpCodes.Ldarg_0);</span><br><span class="line">  il.Emit(OpCodes.Ldfld, context.FieldBuilders[<span class="string">&quot;__obj&quot;</span>]);</span><br><span class="line">  il.Emit(OpCodes.Ldarg_0);</span><br><span class="line">  il.Emit(OpCodes.Ldloc_2);</span><br><span class="line">  il.Emit(OpCodes.Ldloc_0);</span><br><span class="line">  il.Emit(OpCodes.Ldarg_0);</span><br><span class="line">  il.Emit(OpCodes.Ldfld, context.FieldBuilders[<span class="string">&quot;__interceptors&quot;</span>]);</span><br><span class="line">  il.Emit(OpCodes.Newobj, <span class="keyword">typeof</span>(Invocation).GetConstructor(<span class="keyword">new</span> Type[] &#123; <span class="keyword">typeof</span>(<span class="built_in">object</span>), <span class="keyword">typeof</span>(<span class="built_in">object</span>), <span class="keyword">typeof</span>(MethodInfo), <span class="keyword">typeof</span>(<span class="built_in">object</span>[]), <span class="keyword">typeof</span>(IInterceptor[]) &#125;));</span><br><span class="line">  il.Emit(OpCodes.Stloc_3);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// invocation.Proceed()</span></span><br><span class="line">  il.Emit(OpCodes.Ldloc_3);</span><br><span class="line">  il.Emit(OpCodes.Callvirt, <span class="keyword">typeof</span>(Invocation).GetMethod(<span class="string">&quot;Proceed&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回值</span></span><br><span class="line">  <span class="keyword">if</span> (hasResult)</span><br><span class="line">  &#123;</span><br><span class="line">      il.Emit(OpCodes.Ldloc_3);</span><br><span class="line">      il.Emit(OpCodes.Callvirt, <span class="keyword">typeof</span>(Invocation).GetMethod(<span class="string">&quot;get_ReturnValue&quot;</span>));</span><br><span class="line">      <span class="keyword">if</span> (method.ReturnType.IsValueType || method.ReturnType.IsGenericParameter)</span><br><span class="line">          il.Emit(OpCodes.Unbox_Any, method.ReturnType);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  il.Emit(OpCodes.Ret);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代理方法的构建是整个 AOP 的核心，也是相对复杂的地方，在<code>GenerateProxyType</code>方法里，我们对目标类的方法进行了一个过滤，找出了符合要求的方法再进行的 Emit 。这里需要注意的有几个地方：</p>
<p>泛型定义：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (method.IsGenericMethod)</span><br><span class="line">&#123;</span><br><span class="line"> <span class="comment">// 简单支持泛型，未配置泛型约束</span></span><br><span class="line"> methodBuilder.DefineGenericParameters(method.GetGenericArguments().Select(x =&gt; x.Name).ToArray());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取泛型实际传入类型：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (method.IsGenericMethod) <span class="comment">// 定义泛型参数的实际类型</span></span><br><span class="line">&#123;</span><br><span class="line">    il.DeclareLocal(<span class="keyword">typeof</span>(Type[]));     <span class="comment">// genericTypes</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> genericArguments = methodBuilder.GetGenericArguments();</span><br><span class="line"></span><br><span class="line">    il.Emit(OpCodes.Ldc_I4, genericArguments.Length);</span><br><span class="line">    il.Emit(OpCodes.Newarr, <span class="keyword">typeof</span>(Type));</span><br><span class="line">    il.Emit(OpCodes.Stloc_S, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; genericArguments.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        il.Emit(OpCodes.Ldloc_S, <span class="number">4</span>);</span><br><span class="line">        il.Emit(OpCodes.Ldc_I4, i);</span><br><span class="line">        il.Emit(OpCodes.Ldtoken, genericArguments[i]);</span><br><span class="line">        il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Type).GetMethod(<span class="string">&quot;GetTypeFromHandle&quot;</span>, <span class="keyword">new</span> Type[] &#123; <span class="keyword">typeof</span>(RuntimeTypeHandle) &#125;));</span><br><span class="line">        il.Emit(OpCodes.Stelem_Ref);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>泛型方法，返回的<code>MethodInfo</code>是经过<code>MakeGenericMethod</code>处理的（这样<code>Invocation</code>才可以正常调用）：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (method.IsGenericMethod)</span><br><span class="line">&#123;</span><br><span class="line">    il.Emit(OpCodes.Ldloc_S, <span class="number">4</span>);</span><br><span class="line">    il.Emit(OpCodes.Callvirt, <span class="keyword">typeof</span>(MethodInfo).GetMethod(<span class="string">&quot;MakeGenericMethod&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回值处理：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (hasResult)</span><br><span class="line">&#123;</span><br><span class="line">    il.Emit(OpCodes.Ldloc_3);</span><br><span class="line">    il.Emit(OpCodes.Callvirt, <span class="keyword">typeof</span>(Invocation).GetMethod(<span class="string">&quot;get_ReturnValue&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (method.ReturnType.IsValueType || method.ReturnType.IsGenericParameter)</span><br><span class="line">        il.Emit(OpCodes.Unbox_Any, method.ReturnType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出针对返回值的处理，值类型和泛型都会有个拆箱的过程。</p>
<p>为了方便后续的使用，我们定义一个基本的拦截器<code>Attribute</code> ：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.Class, Inherited = true, AllowMultiple = true)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InterceptorAttribute</span> : <span class="title">Attribute</span>, <span class="title">IInterceptor</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 拦截器类型</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="keyword">public</span> Type Type &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> IInterceptor _interceptor;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">InterceptorAttribute</span>()</span> &#123; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">InterceptorAttribute</span>(<span class="params">Type interceptorType</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">this</span>.Type = interceptorType;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Intercept</span>(<span class="params">IInvocation invocation</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.Type != <span class="literal">null</span>)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">if</span> (_interceptor == <span class="literal">null</span>)</span><br><span class="line">               _interceptor = Activator.CreateInstance(<span class="keyword">this</span>.Type) <span class="keyword">as</span> IInterceptor;</span><br><span class="line"></span><br><span class="line">           _interceptor.Intercept(invocation);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 拦截器的执行顺序</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">int</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样一来，我们可以如下使用这个结合了 MEF 和 AOP 的微型框架了：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Interceptor(typeof(MockInterceptor))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MockTarget</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">string</span> <span class="title">GetString</span>(<span class="params"><span class="built_in">int</span> a, <span class="built_in">bool</span> b, <span class="built_in">string</span> c</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">return</span> c;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> T <span class="title">Get</span>&lt;<span class="title">T</span>&gt;(<span class="params">T a</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">return</span> a;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MockInterceptor</span> : <span class="title">IInterceptor</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Intercept</span>(<span class="params">IInvocation invocation</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">if</span> (invocation.Method.Name == <span class="string">&quot;GetString&quot;</span>)</span><br><span class="line">           invocation.ReturnValue = <span class="string">&quot;Intercepted&quot;</span>;</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">           invocation.Proceed();</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">int</span> Order</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但我还是推荐你继承<code>InterceptorAttribute</code>，重写<code>Intercept</code>方法来使用，因为这样我们可以使用<code>Import</code>特性，而上诉代码中的<code>MockInterceptor</code>里是无法使用的。具体的使用，我们看接下来的一节。</p>
<h2 id="综合-AOP-示例分析"><a href="#综合-AOP-示例分析" class="headerlink" title="综合 AOP 示例分析"></a>综合 AOP 示例分析</h2><p>上面的文字里，我们讲了那么一大堆，又花费了些气力构建出了这样一个微型框架，框架并不强大，比如对泛型的支持并不完善，性能也不是最优，可我们应该要有的就是探索和不怕折腾的精神。在我们这个圈子里，没有所谓的天才，只有永远的苦才，越能吃苦的，得到和学会的才会越多。接下来，我便用这个框架，来实现一个非常简单的示例，示例项目的结构如下图：</p>
<p><img data-src="/images/2014/04/13/01.png" alt="示例项目的结构"></p>
<p>这是一个控制台应用程序，Aspects 中存放的是所有切面代码，Models 存放的是模型， Repositories 存放的是仓储，Services 则是服务的存放路径。</p>
<p><code>AppContext</code>是一个全局的上下文信息，用来存放和应用程序生命周期相同的信息，这里存放的是用户名和用户所属角色：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 当前整个应用的上下文</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">AppContext</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> AppContext _current = <span class="keyword">new</span> AppContext();</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> AppContext Current &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> _current; &#125; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 执行该应用的用户，登录用户</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">string</span> User &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 角色</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">string</span> Role &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ServiceLocator</code>则是使用我们自定义的<code>Container</code>实现的一个服务定位器，用来获取服务的具体实现：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个简单的 ServiceLocator</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ServiceLocator</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> AOPCompositionContainer _container;</span><br><span class="line">   <span class="function"><span class="keyword">static</span> <span class="title">ServiceLocator</span>()</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">var</span> catalog = <span class="keyword">new</span> AssemblyCatalog(<span class="keyword">typeof</span>(ServiceLocator).Assembly);</span><br><span class="line">       _container = <span class="keyword">new</span> AOPCompositionContainer(catalog);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TService <span class="title">GetService</span>&lt;<span class="title">TService</span>&gt;()</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">return</span> _container.GetExportedValue&lt;TService&gt;();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">IEnumerable</span>&lt;<span class="title">TService</span>&gt; <span class="title">GetServices</span>&lt;<span class="title">TService</span>&gt;()</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">return</span> _container.GetExportedValues&lt;TService&gt;();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出，我们只在当前的程序集里发现导出，这也是因为只是作为示例的原因。接下来，我们定义系统中可以使用的服务：</p>
<p><strong>ILogService</strong>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILogService</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params"><span class="built_in">string</span> log</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>IAccountService</strong>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IAccountService</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="built_in">bool</span> <span class="title">CreateUser</span>(<span class="params"><span class="built_in">string</span> username, <span class="built_in">string</span> password</span>)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="built_in">bool</span> <span class="title">ExistsUser</span>(<span class="params"><span class="built_in">string</span> username</span>)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这些都是简单到不需要任何解释的东西，我就一笔带过了。</p>
<p>然后是定义模型：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">User</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">public</span> Guid Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>仓储<strong>IUserRepository</strong>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserRepository</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="built_in">bool</span> <span class="title">Add</span>(<span class="params"><span class="built_in">string</span> username, <span class="built_in">string</span> password</span>)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="built_in">bool</span> <span class="title">Exists</span>(<span class="params">Func&lt;User, <span class="built_in">bool</span>&gt; predicate</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再来看一下目前我们项目的整体结构：</p>
<p><img data-src="/images/2014/04/13/02.png" alt="示例项目的结构"></p>
<p>现在我们先实现 Service :</p>
<p><strong>LogServiceImpl</strong>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Export(typeof(ILogService))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LogServiceImpl</span> : <span class="title">ILogService</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Log</span>(<span class="params"><span class="built_in">string</span> log</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">var</span> currentColor = Console.ForegroundColor;</span><br><span class="line">       Console.ForegroundColor = ConsoleColor.Green;</span><br><span class="line"></span><br><span class="line">       Console.WriteLine(<span class="string">&quot;Log:&quot;</span>);</span><br><span class="line">       Console.WriteLine(log);</span><br><span class="line">       Console.WriteLine();</span><br><span class="line"></span><br><span class="line">       Console.ForegroundColor = currentColor;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只是在控制台输入信息。</p>
<p><strong>AccountServiceImpl</strong>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AOPExport(typeof(IAccountService))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AccountServiceImpl</span> : <span class="title">IAccountService</span></span><br><span class="line">&#123;</span><br><span class="line">   [<span class="meta">Import</span>]</span><br><span class="line">   <span class="keyword">protected</span> IUserRepository UserRepository &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span>  <span class="built_in">bool</span> <span class="title">CreateUser</span>(<span class="params"><span class="built_in">string</span> username, <span class="built_in">string</span> password</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(username) || <span class="built_in">string</span>.IsNullOrWhiteSpace(password))</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;用户名或密码不可为空！&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (ExistsUser(username))</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;用户名已存在！&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> UserRepository.Add(username, password);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">ExistsUser</span>(<span class="params"><span class="built_in">string</span> username</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(username))</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;要检测的用户名不可为空！&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> UserRepository.Exists(x =&gt; x.Name == username);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：这里我们使用的是<code>AOPExport</code>，方法定义为<code>virtual</code>，并且导入了<code>IUserRepository</code>，在具体的方法里直接抛出了异常。</p>
<p>我们再实现仓储：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AOPExport(typeof(IUserRepository))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserRepositoryImpl</span> : <span class="title">IUserRepository</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">Add</span>(<span class="params"><span class="built_in">string</span> username, <span class="built_in">string</span> password</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment">// ...</span></span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">Exists</span>(<span class="params">Func&lt;Models.User, <span class="built_in">bool</span>&gt; predicate</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">var</span> user = <span class="keyword">new</span> Models.User()</span><br><span class="line">       &#123;</span><br><span class="line">           Id = Guid.NewGuid(),</span><br><span class="line">           Name = <span class="string">&quot;Sun.M&quot;</span>,</span><br><span class="line">           Password = <span class="string">&quot;123789&quot;</span></span><br><span class="line">       &#125;;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> predicate.Invoke(user);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样，我们使用了<code>AOPExport</code>，方法也是定义成了<code>virtual</code>，这些都是为了后面我们能够插入切面代码。现在我们的主要代码都已经写得差不多了，回顾下这些代码，其实很简单，我们定义了两个 Service，并在其中的一个 Service 中导入了一个 Repository ，依赖关系就是这么简单。那么我们来看看使用部分代码的定义吧：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       AppContext.Current.User = <span class="string">&quot;Sun.M&quot;</span>;</span><br><span class="line">       AppContext.Current.Role = <span class="string">&quot;Admin&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="keyword">var</span> accoutService = ServiceLocator.GetService&lt;Services.IAccountService&gt;();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">var</span> createResult = accoutService.CreateUser(<span class="string">&quot;Sun.M&quot;</span>, <span class="string">&quot;1343434&quot;</span>);</span><br><span class="line">       Console.WriteLine(createResult); <span class="comment">// throw exception : 名称已存在</span></span><br><span class="line"></span><br><span class="line">       AppContext.Current.Role = <span class="string">&quot;Other&quot;</span>;</span><br><span class="line">       createResult = accoutService.CreateUser(<span class="string">&quot;M.K&quot;</span>, <span class="string">&quot;1343434&quot;</span>);</span><br><span class="line">       Console.WriteLine(createResult); <span class="comment">// throw exception : 没有权限</span></span><br><span class="line"></span><br><span class="line">       AppContext.Current.Role = <span class="string">&quot;Admin&quot;</span>;</span><br><span class="line">       createResult = accoutService.CreateUser(<span class="string">&quot;M.K&quot;</span>, <span class="string">&quot;1343434&quot;</span>);</span><br><span class="line">       Console.WriteLine(createResult); <span class="comment">// 添加成功</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       Console.ReadKey();</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在运行程序，会收到异常，并且程序无法继续执行。下面，我们就来使用 AOP 来处理几个非常常见的问题：异常、日志和权限。</p>
<h3 id="异常处理："><a href="#异常处理：" class="headerlink" title="异常处理："></a>异常处理：</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.Class, Inherited = true, AllowMultiple = false)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExceptionInterceptorAttribute</span> : <span class="title">InterceptorAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Intercept</span>(<span class="params">IInvocation invocation</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">try</span></span><br><span class="line">       &#123;</span><br><span class="line">           invocation.Proceed();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">catch</span> (System.Exception ex)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> currentColor = Console.ForegroundColor;</span><br><span class="line">           Console.ForegroundColor = ConsoleColor.Red;</span><br><span class="line"></span><br><span class="line">           Console.WriteLine(<span class="string">&quot;Error:&quot;</span>);</span><br><span class="line">           Console.WriteLine(ex.InnerException.Message);</span><br><span class="line">           Console.WriteLine();</span><br><span class="line"></span><br><span class="line">           Console.ForegroundColor = currentColor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (invocation.Method.ReturnType != Type.GetType(<span class="string">&quot;System.Void&quot;</span>))</span><br><span class="line">               invocation.ReturnValue = CreateTypeDefaultValue(invocation.Method.ReturnType);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="built_in">object</span> <span class="title">CreateTypeDefaultValue</span>(<span class="params">Type type</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">if</span> (type.IsValueType)</span><br><span class="line">           <span class="keyword">return</span> Activator.CreateInstance(type);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意这里对于返回值的处理，其实我们可以把这个返回默认值的功能，由<code>Invocation</code>自己去实现，这里就不作修改了，有兴趣的同学自己动手实践下吧。</p>
<h3 id="日志处理："><a href="#日志处理：" class="headerlink" title="日志处理："></a>日志处理：</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.Class, Inherited = true, AllowMultiple = false)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LogInterceptorAttribute</span> : <span class="title">InterceptorAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">   [<span class="meta">Import</span>]</span><br><span class="line">   <span class="keyword">protected</span> ILogService LogService &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Intercept</span>(<span class="params">IInvocation invocation</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       LogService.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Method:&#123;0&#125; User:&#123;1&#125;&quot;</span>, invocation.Method.Name, AppContext.Current.User));</span><br><span class="line"></span><br><span class="line">       invocation.Proceed();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (invocation.ReturnValue != <span class="literal">null</span>)</span><br><span class="line">           LogService.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Method:&#123;0&#125; ReturnValue:&#123;1&#125;&quot;</span>, invocation.Method.Name, invocation.ReturnValue));</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于日志的处理，就比较简单了，但这里使用了 Import 特性，这是一个非常实用的功能。这里，我们记录下了方法调用的一些信息。</p>
<h3 id="权限处理："><a href="#权限处理：" class="headerlink" title="权限处理："></a>权限处理：</h3><p><strong>SecurityInterceptorAttribute</strong>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.Class, Inherited = true, AllowMultiple = false)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SecurityInterceptorAttribute</span> : <span class="title">InterceptorAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Intercept</span>(<span class="params">IInvocation invocation</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">var</span> securityAttrs = invocation.Method.GetCustomAttributes(<span class="keyword">typeof</span>(SecurityAttribute), <span class="literal">true</span>);</span><br><span class="line">       <span class="keyword">if</span> (securityAttrs == <span class="literal">null</span> || securityAttrs.Length == <span class="number">0</span>)</span><br><span class="line">       &#123;</span><br><span class="line">           invocation.Proceed(); <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="keyword">var</span> requiredRoles = securityAttrs.Select(x =&gt; ((SecurityAttribute)x).Role);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (requiredRoles.Any(x =&gt; x == AppContext.Current.Role) == <span class="literal">false</span>)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> System.Exception(<span class="built_in">string</span>.Format(<span class="string">&quot;对&#123;0&#125;的访问没有权限&quot;</span>, invocation.Method.Name));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       invocation.Proceed();</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>SecurityAttribute</strong>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.Method | AttributeTargets.Property, AllowMultiple = true)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SecurityAttribute</span> : <span class="title">Attribute</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">SecurityAttribute</span>(<span class="params"><span class="built_in">string</span> role</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">this</span>.Role = role;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">string</span> Role &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于权限的处理，我们多定义出了一<code>Attribute</code>，用来标识那些方法是需要权限判定的，并且指定了判定条件，即 Role 。</p>
<p>现在我们定义好了这么些个拦截器（切面代码），具体使用也非常简单，我们在需要的地方标记上去即可：</p>
<p><strong>AccountServiceImpl</strong>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">LogInterceptor(Order = 0)</span>]</span><br><span class="line">[<span class="meta">ExceptionInterceptor(Order = 1)</span>]</span><br><span class="line">[<span class="meta">AOPExport(typeof(IAccountService))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AccountServiceImpl</span> : <span class="title">IAccountService</span></span><br></pre></td></tr></table></figure>

<p><strong>UserRepositoryImpl</strong>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">SecurityInterceptor</span>]</span><br><span class="line">[<span class="meta">AOPExport(typeof(IUserRepository))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserRepositoryImpl</span> : <span class="title">IUserRepository</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">   [<span class="meta">Security(<span class="string">&quot;Admin&quot;</span>)</span>]</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">Add</span>(<span class="params"><span class="built_in">string</span> username, <span class="built_in">string</span> password</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>如此一来，我们的拦截器已经能正常工作了。上述代码中，定义了<code>UserRepositoryImpl</code>中的<code>Add</code>方法只能被 Role 为 Admin 的用户调用。这里需要注意的是拦截器的 Order ，对于异常拦截器而言，最好是越先执行越安全，而权限则最好放在所有拦截器执行完后再执行，具体原因不说大家也都明白。</p>
<p>最后我们看一下执行结果：</p>
<p><img data-src="/images/2014/04/13/03.png" alt="执行结果图"></p>
<p>时候也不早了，这一篇就到这里吧！附上项目源码地址： <a target="_blank" rel="noopener" href="https://github.com/prinsun/BlogDemo.MEF.AOP">https://github.com/prinsun/BlogDemo.MEF.AOP</a></p>

    </div>

    
    
    
      


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2013/04/18/mef-core-note-pattern-or-design/" rel="prev" title="MEF核心笔记（5）是模式还是设计">
      <i class="fa fa-chevron-left"></i> MEF核心笔记（5）是模式还是设计
    </a></div>
      <div class="post-nav-item">
    <a href="/2014/06/28/pjsip-for-ios-build-mutil-target-support/" rel="next" title="pjsip for iOS：编译多平台支持的静态库">
      pjsip for iOS：编译多平台支持的静态库 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#IOC-%E5%92%8C-AOP-%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="nav-number">1.</span> <span class="nav-text">IOC 和 AOP 的概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95-MEF%EF%BC%8C%E4%BD%BF%E5%85%B6%E6%94%AF%E6%8C%81-AOP"><span class="nav-number">2.</span> <span class="nav-text">扩展 MEF，使其支持 AOP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84-AOP-%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.</span> <span class="nav-text">简单的 AOP 框架实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%BC%E5%90%88-AOP-%E7%A4%BA%E4%BE%8B%E5%88%86%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">综合 AOP 示例分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%EF%BC%9A"><span class="nav-number">4.1.</span> <span class="nav-text">异常处理：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86%EF%BC%9A"><span class="nav-number">4.2.</span> <span class="nav-text">日志处理：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E5%A4%84%E7%90%86%EF%BC%9A"><span class="nav-number">4.3.</span> <span class="nav-text">权限处理：</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Makee"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Makee</p>
  <div class="site-description" itemprop="description">LIFE IS NOT EASY BUT HARD WORK ALWAYS PAYS.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/prinsun" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;prinsun" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/prinsun" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;prinsun" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Makee</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  
  <script data-pjax>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>















    <div id="pjax">
  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'FR2mSA60UEvzmYC24OgbdtvW-gzGzoHsz',
      appKey     : 'L70FAQa4gHBwVkjRwKJGajlx',
      placeholder: "欢迎留言交流...",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

    </div>
</body>
</html>
